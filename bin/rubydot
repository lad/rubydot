#!/usr/bin/env ruby
# encoding: UTF-8

require 'docopt'
require 'rubydot'
require 'logger'

SCRIPT = File.basename(__FILE__)

# rubocop: disable LineLength
DOC = <<DOCOPT
RubyDot - Simple UML Generator

Usage:
  #{SCRIPT} [-v] [-o=OUTFILE] PATH
  #{SCRIPT} --version

Options:
  -o OUTFILE, --output=OUTFILE    Output file
  -h, --help                      Show this help
  -v, --verbose                   Show verbose output
  --version                       Show version
DOCOPT

# Application runner
class App
  def initialize(usage)
    @opts = Docopt.docopt(usage)
    @path = @opts['PATH']
    @log_level = @opts['--verbose'] ? Logger::DEBUG : Logger::INFO
    @output = @opts['--output'].nil? ? default_output : @opts['--output']
    fail Errno::EEXIST, "#{@output}" if File.exists?(@output)
  end

  def run
    if @opts['--version']
      puts Rubydot::VERSION
    else
      Rubydot::Generator.new(@path).run(@output)
    end
  end

  def default_output
    "#{File.basename(@path).partition('.')[0]}.png"
  end

  def self.main
    App.new(DOC).run
    return 0
  rescue Rubydot::Error, Docopt::Exit, Errno::EEXIST, RuntimeError => e
    puts e.message
    return 1
  end
end

trap 'INT' do
  puts 'Interrupted...'
  exit 1
end

exit App.main
